!function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function t(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))}function e(t,e){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var r="undefined"!=typeof self?self:void 0,n="URLSearchParams"in r,i="Symbol"in r&&"iterator"in Symbol,o="FileReader"in r&&"Blob"in r&&function(){try{return new Blob,!0}catch(t){return!1}}(),s="FormData"in r,a="ArrayBuffer"in r;if(a)var l=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(t){return t&&l.indexOf(Object.prototype.toString.call(t))>-1};function h(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(t)||""===t)throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function c(t){return"string"!=typeof t&&(t=String(t)),t}function f(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return i&&(e[Symbol.iterator]=function(){return e}),e}function p(t){this.map={},t instanceof p?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function y(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function g(t){return new Promise((function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}}))}function d(t){var e=new FileReader,r=g(e);return e.readAsArrayBuffer(t),r}function v(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function m(){return this.bodyUsed=!1,this._initBody=function(t){var e;this.bodyUsed=this.bodyUsed,this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:o&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:s&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:n&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():a&&o&&((e=t)&&DataView.prototype.isPrototypeOf(e))?(this._bodyArrayBuffer=v(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):a&&(ArrayBuffer.prototype.isPrototypeOf(t)||u(t))?this._bodyArrayBuffer=v(t):this._bodyText=t=Object.prototype.toString.call(t):this._bodyText="",this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},o&&(this.blob=function(){var t=y(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?y(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(d)}),this.text=function(){var t,e,r,n=y(this);if(n)return n;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,r=g(e),e.readAsText(t),r;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},s&&(this.formData=function(){return this.text().then(w)}),this.json=function(){return this.text().then(JSON.parse)},this}p.prototype.append=function(t,e){t=h(t),e=c(e);var r=this.map[t];this.map[t]=r?r+", "+e:e},p.prototype.delete=function(t){delete this.map[h(t)]},p.prototype.get=function(t){return t=h(t),this.has(t)?this.map[t]:null},p.prototype.has=function(t){return this.map.hasOwnProperty(h(t))},p.prototype.set=function(t,e){this.map[h(t)]=c(e)},p.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},p.prototype.keys=function(){var t=[];return this.forEach((function(e,r){t.push(r)})),f(t)},p.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),f(t)},p.prototype.entries=function(){var t=[];return this.forEach((function(e,r){t.push([r,e])})),f(t)},i&&(p.prototype[Symbol.iterator]=p.prototype.entries);var b=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function x(t,e){var r,n,i=(e=e||{}).body;if(t instanceof x){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new p(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"same-origin",!e.headers&&this.headers||(this.headers=new p(e.headers)),this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),b.indexOf(n)>-1?n:r),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(i),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==e.cache&&"no-cache"!==e.cache)){var o=/([?&])_=[^&]*/;if(o.test(this.url))this.url=this.url.replace(o,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function w(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),i=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(i))}})),e}function E(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"",this.headers=new p(e.headers),this.url=e.url||"",this._initBody(t)}x.prototype.clone=function(){return new x(this,{body:this._bodyInit})},m.call(x.prototype),m.call(E.prototype),E.prototype.clone=function(){return new E(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new p(this.headers),url:this.url})},E.error=function(){var t=new E(null,{status:0,statusText:""});return t.type="error",t};var S=[301,302,303,307,308];E.redirect=function(t,e){if(-1===S.indexOf(e))throw new RangeError("Invalid status code");return new E(null,{status:e,headers:{location:t}})};var _=r.DOMException;function k(t,e){return new Promise((function(n,i){var s=new x(t,e);if(s.signal&&s.signal.aborted)return i(new _("Aborted","AbortError"));var l=new XMLHttpRequest;function u(){l.abort()}l.onload=function(){var t,e,r={status:l.status,statusText:l.statusText,headers:(t=l.getAllResponseHeaders()||"",e=new p,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var r=t.split(":"),n=r.shift().trim();if(n){var i=r.join(":").trim();e.append(n,i)}})),e)};r.url="responseURL"in l?l.responseURL:r.headers.get("X-Request-URL");var i="response"in l?l.response:l.responseText;setTimeout((function(){n(new E(i,r))}),0)},l.onerror=function(){setTimeout((function(){i(new TypeError("Network request failed"))}),0)},l.ontimeout=function(){setTimeout((function(){i(new TypeError("Network request failed"))}),0)},l.onabort=function(){setTimeout((function(){i(new _("Aborted","AbortError"))}),0)},l.open(s.method,function(t){try{return""===t&&r.location.href?r.location.href:t}catch(e){return t}}(s.url),!0),"include"===s.credentials?l.withCredentials=!0:"omit"===s.credentials&&(l.withCredentials=!1),"responseType"in l&&(o?l.responseType="blob":a&&s.headers.get("Content-Type")&&-1!==s.headers.get("Content-Type").indexOf("application/octet-stream")&&(l.responseType="arraybuffer")),s.headers.forEach((function(t,e){l.setRequestHeader(e,t)})),s.signal&&(s.signal.addEventListener("abort",u),l.onreadystatechange=function(){4===l.readyState&&s.signal.removeEventListener("abort",u)}),l.send(void 0===s._bodyInit?null:s._bodyInit)}))}"function"!=typeof _&&((_=function(t,e){this.message=t,this.name=e;var r=Error(t);this.stack=r.stack}).prototype=Object.create(Error.prototype),_.prototype.constructor=_),k.polyfill=!0,r.fetch||(r.fetch=k,r.Headers=p,r.Request=x,r.Response=E);var I=function(){function t(t){this.queryObject=t}return t.prototype.toString=function(e){void 0===e&&(e=!0);var r=this.queryObject.entityType,n=[];if(this.queryObject.id){if(!e)return this.queryObject.entityType+"("+this.queryObject.id+")";r=r+"("+this.queryObject.id+")",delete this.queryObject.id}for(var i in this.queryObject)this.queryObject[i]&&("select"!=i?"expand"!=i?"entityType"!=i&&n.push("$"+i+"="+this.queryObject[i].toString()):n.push("$expand="+this.queryObject.expand.map((function(e){return new t(e).toString(!1)})).join(",")):n.push("$select="+this.queryObject.select.join(",")));return 0==n.length?r:e?r+"?"+n.map(encodeURI).join("&"):r+"("+n.map(encodeURI).join(";")+")"},t}(),P=function(){function r(t){this.baseUrl=t}return r.prototype.getGeoJson=function(r){var n=this;return new Promise((function(i,o){return t(n,void 0,void 0,(function(){var t,n,o,s,a;return e(this,(function(e){switch(e.label){case 0:return t=this.baseUrl+"/"+new I(r).toString(),[4,fetch(t)];case 1:return[4,e.sent().json()];case 2:n=e.sent(),o=n["@iot.nextLink"],e.label=3;case 3:return o?[4,fetch(o)]:[3,6];case 4:return[4,e.sent().json()];case 5:return s=e.sent(),(a=n.value).push.apply(a,s.value),o=s["@iot.nextLink"],[3,3];case 6:return i(n),[2]}}))}))}))},r}();
/**
     * splaytree v3.0.1
     * Fast Splay tree for Node and browser
     *
     * @author Alexander Milevski <info@w8r.name>
     * @license MIT
     * @preserve
     */
class T{constructor(t,e){this.next=null,this.key=t,this.data=e,this.left=null,this.right=null}}function O(t,e){return t>e?1:t<e?-1:0}function R(t,e,r){const n=new T(null,null);let i=n,o=n;for(;;){const n=r(t,e.key);if(n<0){if(null===e.left)break;if(r(t,e.left.key)<0){const t=e.left;if(e.left=t.right,t.right=e,null===(e=t).left)break}o.left=e,o=e,e=e.left}else{if(!(n>0))break;if(null===e.right)break;if(r(t,e.right.key)>0){const t=e.right;if(e.right=t.left,t.left=e,null===(e=t).right)break}i.right=e,i=e,e=e.right}}return i.right=e.left,o.left=e.right,e.left=n.right,e.right=n.left,e}function A(t,e,r,n){const i=new T(t,e);if(null===r)return i.left=i.right=null,i;const o=n(t,(r=R(t,r,n)).key);return o<0?(i.left=r.left,i.right=r,r.left=null):o>=0&&(i.right=r.right,i.left=r,r.right=null),i}function B(t,e,r){let n=null,i=null;if(e){const o=r((e=R(t,e,r)).key,t);0===o?(n=e.left,i=e.right):o<0?(i=e.right,e.right=null,n=e):(n=e.left,e.left=null,i=e)}return{left:n,right:i}}class U{constructor(t=O){this._root=null,this._size=0,this._comparator=t}insert(t,e){return this._size++,this._root=A(t,e,this._root,this._comparator)}add(t,e){const r=new T(t,e);null===this._root&&(r.left=r.right=null,this._size++,this._root=r);const n=this._comparator,i=R(t,this._root,n),o=n(t,i.key);return 0===o?this._root=i:(o<0?(r.left=i.left,r.right=i,i.left=null):o>0&&(r.right=i.right,r.left=i,i.right=null),this._size++,this._root=r),this._root}remove(t){this._root=this._remove(t,this._root,this._comparator)}_remove(t,e,r){let n;if(null===e)return null;return 0===r(t,(e=R(t,e,r)).key)?(null===e.left?n=e.right:(n=R(t,e.left,r),n.right=e.right),this._size--,n):e}pop(){let t=this._root;if(t){for(;t.left;)t=t.left;return this._root=R(t.key,this._root,this._comparator),this._root=this._remove(t.key,this._root,this._comparator),{key:t.key,data:t.data}}return null}findStatic(t){let e=this._root;const r=this._comparator;for(;e;){const n=r(t,e.key);if(0===n)return e;e=n<0?e.left:e.right}return null}find(t){return this._root&&(this._root=R(t,this._root,this._comparator),0!==this._comparator(t,this._root.key))?null:this._root}contains(t){let e=this._root;const r=this._comparator;for(;e;){const n=r(t,e.key);if(0===n)return!0;e=n<0?e.left:e.right}return!1}forEach(t,e){let r=this._root;const n=[];let i=!1;for(;!i;)null!==r?(n.push(r),r=r.left):0!==n.length?(r=n.pop(),t.call(e,r),r=r.right):i=!0;return this}range(t,e,r,n){const i=[],o=this._comparator;let s,a=this._root;for(;0!==i.length||a;)if(a)i.push(a),a=a.left;else{if(a=i.pop(),s=o(a.key,e),s>0)break;if(o(a.key,t)>=0&&r.call(n,a))return this;a=a.right}return this}keys(){const t=[];return this.forEach(({key:e})=>t.push(e)),t}values(){const t=[];return this.forEach(({data:e})=>t.push(e)),t}min(){return this._root?this.minNode(this._root).key:null}max(){return this._root?this.maxNode(this._root).key:null}minNode(t=this._root){if(t)for(;t.left;)t=t.left;return t}maxNode(t=this._root){if(t)for(;t.right;)t=t.right;return t}at(t){let e=this._root,r=!1,n=0;const i=[];for(;!r;)if(e)i.push(e),e=e.left;else if(i.length>0){if(e=i.pop(),n===t)return e;n++,e=e.right}else r=!0;return null}next(t){let e=this._root,r=null;if(t.right){for(r=t.right;r.left;)r=r.left;return r}const n=this._comparator;for(;e;){const i=n(t.key,e.key);if(0===i)break;i<0?(r=e,e=e.left):e=e.right}return r}prev(t){let e=this._root,r=null;if(null!==t.left){for(r=t.left;r.right;)r=r.right;return r}const n=this._comparator;for(;e;){const i=n(t.key,e.key);if(0===i)break;i<0?e=e.left:(r=e,e=e.right)}return r}clear(){return this._root=null,this._size=0,this}toList(){return function(t){let e=t;const r=[];let n=!1;const i=new T(null,null);let o=i;for(;!n;)e?(r.push(e),e=e.left):r.length>0?(e=o=o.next=r.pop(),e=e.right):n=!0;return o.next=null,i.next}(this._root)}load(t,e=[],r=!1){let n=t.length;const i=this._comparator;if(r&&function t(e,r,n,i,o){if(n>=i)return;const s=e[n+i>>1];let a=n-1,l=i+1;for(;;){do{a++}while(o(e[a],s)<0);do{l--}while(o(e[l],s)>0);if(a>=l)break;let t=e[a];e[a]=e[l],e[l]=t,t=r[a],r[a]=r[l],r[l]=t}t(e,r,n,l,o),t(e,r,l+1,i,o)}(t,e,0,n-1,i),null===this._root)this._root=function t(e,r,n,i){const o=i-n;if(o>0){const s=n+Math.floor(o/2),a=e[s],l=r[s],u=new T(a,l);return u.left=t(e,r,n,s),u.right=t(e,r,s+1,i),u}return null}(t,e,0,n),this._size=n;else{const r=function(t,e,r){const n=new T(null,null);let i=n,o=t,s=e;for(;null!==o&&null!==s;)r(o.key,s.key)<0?(i.next=o,o=o.next):(i.next=s,s=s.next),i=i.next;null!==o?i.next=o:null!==s&&(i.next=s);return n.next}(this.toList(),function(t,e){const r=new T(null,null);let n=r;for(let r=0;r<t.length;r++)n=n.next=new T(t[r],e[r]);return n.next=null,r.next}(t,e),i);n=this._size+n,this._root=function t(e,r,n){const i=n-r;if(i>0){const o=r+Math.floor(i/2),s=t(e,r,o),a=e.head;return a.left=s,e.head=e.head.next,a.right=t(e,o+1,n),a}return null}({head:r},0,n)}return this}isEmpty(){return null===this._root}get size(){return this._size}get root(){return this._root}toString(t=(t=>String(t.key))){const e=[];return function t(e,r,n,i,o){if(e){i(`${r}${n?"└── ":"├── "}${o(e)}\n`);const s=r+(n?"    ":"│   ");e.left&&t(e.left,s,!1,i,o),e.right&&t(e.right,s,!0,i,o)}}(this._root,"",!0,t=>e.push(t),t),e.join("")}update(t,e,r){const n=this._comparator;let{left:i,right:o}=B(t,this._root,n);n(t,e)<0?o=A(e,r,o,n):i=A(e,r,i,n),this._root=function(t,e,r){return null===e?t:(null===t||((e=R(t.key,e,r)).left=t),e)}(i,o,n)}split(t){return B(t,this._root,this._comparator)}}function j(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function N(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function M(t,e,r){return e&&N(t.prototype,e),r&&N(t,r),t}var z=function(t,e){return t.ll.x<=e.x&&e.x<=t.ur.x&&t.ll.y<=e.y&&e.y<=t.ur.y},G=function(t,e){if(e.ur.x<t.ll.x||t.ur.x<e.ll.x||e.ur.y<t.ll.y||t.ur.y<e.ll.y)return null;var r=t.ll.x<e.ll.x?e.ll.x:t.ll.x,n=t.ur.x<e.ur.x?t.ur.x:e.ur.x;return{ll:{x:r,y:t.ll.y<e.ll.y?e.ll.y:t.ll.y},ur:{x:n,y:t.ur.y<e.ur.y?t.ur.y:e.ur.y}}},F=Number.EPSILON;void 0===F&&(F=Math.pow(2,-52));var C=F*F,D=function(t,e){if(-F<t&&t<F&&-F<e&&e<F)return 0;var r=t-e;return r*r<C*t*e?0:t<e?-1:1},q=function(){function t(){j(this,t),this.reset()}return M(t,[{key:"reset",value:function(){this.xRounder=new V,this.yRounder=new V}},{key:"round",value:function(t,e){return{x:this.xRounder.round(t),y:this.yRounder.round(e)}}}]),t}(),V=function(){function t(){j(this,t),this.tree=new U,this.round(0)}return M(t,[{key:"round",value:function(t){var e=this.tree.add(t),r=this.tree.prev(e);if(null!==r&&0===D(e.key,r.key))return this.tree.remove(t),r.key;var n=this.tree.next(e);return null!==n&&0===D(e.key,n.key)?(this.tree.remove(t),n.key):t}}]),t}(),J=new q,Z=function(t,e){return t.x*e.y-t.y*e.x},H=function(t,e){return t.x*e.x+t.y*e.y},Y=function(t,e,r){var n={x:e.x-t.x,y:e.y-t.y},i={x:r.x-t.x,y:r.y-t.y},o=Z(n,i);return D(o,0)},$=function(t){return Math.sqrt(H(t,t))},W=function(t,e,r){var n={x:e.x-t.x,y:e.y-t.y},i={x:r.x-t.x,y:r.y-t.y};return H(i,n)/$(i)/$(n)},X=function(t,e,r){return 0===e.y?null:{x:t.x+e.x/e.y*(r-t.y),y:r}},Q=function(t,e,r){return 0===e.x?null:{x:r,y:t.y+e.y/e.x*(r-t.x)}},K=function(){function t(e,r){j(this,t),void 0===e.events?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=r}return M(t,null,[{key:"compare",value:function(e,r){var n=t.comparePoints(e.point,r.point);return 0!==n?n:(e.point!==r.point&&e.link(r),e.isLeft!==r.isLeft?e.isLeft?1:-1:et.compare(e.segment,r.segment))}},{key:"comparePoints",value:function(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:t.y>e.y?1:0}}]),M(t,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var e=t.point.events,r=0,n=e.length;r<n;r++){var i=e[r];this.point.events.push(i),i.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,e=0;e<t;e++){var r=this.point.events[e];if(void 0===r.segment.consumedBy)for(var n=e+1;n<t;n++){var i=this.point.events[n];void 0===i.consumedBy&&(r.otherSE.point.events===i.otherSE.point.events&&r.segment.consume(i.segment))}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],e=0,r=this.point.events.length;e<r;e++){var n=this.point.events[e];n!==this&&!n.segment.ringOut&&n.segment.isInResult()&&t.push(n)}return t}},{key:"getLeftmostComparator",value:function(t){var e=this,r=new Map,n=function(n){var i,o,s,a,l,u=n.otherSE;r.set(n,{sine:(i=e.point,o=t.point,s=u.point,a={x:o.x-i.x,y:o.y-i.y},l={x:s.x-i.x,y:s.y-i.y},Z(l,a)/$(l)/$(a)),cosine:W(e.point,t.point,u.point)})};return function(t,e){r.has(t)||n(t),r.has(e)||n(e);var i=r.get(t),o=i.sine,s=i.cosine,a=r.get(e),l=a.sine,u=a.cosine;return o>=0&&l>=0?s<u?1:s>u?-1:0:o<0&&l<0?s<u?-1:s>u?1:0:l<o?-1:l>o?1:0}}}]),t}(),tt=0,et=function(){function t(e,r,n,i){j(this,t),this.id=++tt,this.leftSE=e,e.segment=this,e.otherSE=r,this.rightSE=r,r.segment=this,r.otherSE=e,this.rings=n,this.windings=i}return M(t,null,[{key:"compare",value:function(t,e){var r=t.leftSE.point.x,n=e.leftSE.point.x,i=t.rightSE.point.x,o=e.rightSE.point.x;if(o<r)return 1;if(i<n)return-1;var s=t.leftSE.point.y,a=e.leftSE.point.y,l=t.rightSE.point.y,u=e.rightSE.point.y;if(r<n){if(a<s&&a<l)return 1;if(a>s&&a>l)return-1;var h=t.comparePoint(e.leftSE.point);if(h<0)return 1;if(h>0)return-1;var c=e.comparePoint(t.rightSE.point);return 0!==c?c:-1}if(r>n){if(s<a&&s<u)return-1;if(s>a&&s>u)return 1;var f=e.comparePoint(t.leftSE.point);if(0!==f)return f;var p=t.comparePoint(e.rightSE.point);return p<0?1:p>0?-1:1}if(s<a)return-1;if(s>a)return 1;if(i<o){var y=e.comparePoint(t.rightSE.point);if(0!==y)return y}if(i>o){var g=t.comparePoint(e.rightSE.point);if(g<0)return 1;if(g>0)return-1}if(i!==o){var d=l-s,v=i-r,m=u-a,b=o-n;if(d>v&&m<b)return 1;if(d<v&&m>b)return-1}return i>o?1:i<o||l<u?-1:l>u?1:t.id<e.id?-1:t.id>e.id?1:0}}]),M(t,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,e=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<e?t:e},ur:{x:this.rightSE.point.x,y:t>e?t:e}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var e=this.leftSE.point,r=this.rightSE.point,n=this.vector();if(e.x===r.x)return t.x===e.x?0:t.x<e.x?1:-1;var i=(t.y-e.y)/n.y,o=e.x+i*n.x;if(t.x===o)return 0;var s=(t.x-e.x)/n.x,a=e.y+s*n.y;return t.y===a?0:t.y<a?-1:1}},{key:"getIntersection",value:function(t){var e=this.bbox(),r=t.bbox(),n=G(e,r);if(null===n)return null;var i=this.leftSE.point,o=this.rightSE.point,s=t.leftSE.point,a=t.rightSE.point,l=z(e,s)&&0===this.comparePoint(s),u=z(r,i)&&0===t.comparePoint(i),h=z(e,a)&&0===this.comparePoint(a),c=z(r,o)&&0===t.comparePoint(o);if(u&&l)return c&&!h?o:!c&&h?a:null;if(u)return h&&i.x===a.x&&i.y===a.y?null:i;if(l)return c&&o.x===s.x&&o.y===s.y?null:s;if(c&&h)return null;if(c)return o;if(h)return a;var f=function(t,e,r,n){if(0===e.x)return Q(r,n,t.x);if(0===n.x)return Q(t,e,r.x);if(0===e.y)return X(r,n,t.y);if(0===n.y)return X(t,e,r.y);var i=Z(e,n);if(0==i)return null;var o={x:r.x-t.x,y:r.y-t.y},s=Z(o,e)/i,a=Z(o,n)/i;return{x:(t.x+a*e.x+(r.x+s*n.x))/2,y:(t.y+a*e.y+(r.y+s*n.y))/2}}(i,this.vector(),s,t.vector());return null===f?null:z(n,f)?J.round(f.x,f.y):null}},{key:"split",value:function(e){var r=[],n=void 0!==e.events,i=new K(e,!0),o=new K(e,!1),s=this.rightSE;this.replaceRightSE(o),r.push(o),r.push(i);var a=new t(i,s,this.rings.slice(),this.windings.slice());return K.comparePoints(a.leftSE.point,a.rightSE.point)>0&&a.swapEvents(),K.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),n&&(i.checkForConsuming(),o.checkForConsuming()),r}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var e=0,r=this.windings.length;e<r;e++)this.windings[e]*=-1}},{key:"consume",value:function(e){for(var r=this,n=e;r.consumedBy;)r=r.consumedBy;for(;n.consumedBy;)n=n.consumedBy;var i=t.compare(r,n);if(0!==i){if(i>0){var o=r;r=n,n=o}if(r.prev===n){var s=r;r=n,n=s}for(var a=0,l=n.rings.length;a<l;a++){var u=n.rings[a],h=n.windings[a],c=r.rings.indexOf(u);-1===c?(r.rings.push(u),r.windings.push(h)):r.windings[c]+=h}n.rings=null,n.windings=null,n.consumedBy=r,n.leftSE.consumedBy=r.leftSE,n.rightSE.consumedBy=r.rightSE}}},{key:"prevInResult",value:function(){return void 0!==this._prevInResult||(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null),this._prevInResult}},{key:"beforeState",value:function(){if(void 0!==this._beforeState)return this._beforeState;if(this.prev){var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}else this._beforeState={rings:[],windings:[],multiPolys:[]};return this._beforeState}},{key:"afterState",value:function(){if(void 0!==this._afterState)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var e=this._afterState.rings,r=this._afterState.windings,n=this._afterState.multiPolys,i=0,o=this.rings.length;i<o;i++){var s=this.rings[i],a=this.windings[i],l=e.indexOf(s);-1===l?(e.push(s),r.push(a)):r[l]+=a}for(var u=[],h=[],c=0,f=e.length;c<f;c++)if(0!==r[c]){var p=e[c],y=p.poly;if(-1===h.indexOf(y))if(p.isExterior)u.push(y);else{-1===h.indexOf(y)&&h.push(y);var g=u.indexOf(p.poly);-1!==g&&u.splice(g,1)}}for(var d=0,v=u.length;d<v;d++){var m=u[d].multiPoly;-1===n.indexOf(m)&&n.push(m)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(void 0!==this._isInResult)return this._isInResult;var t=this.beforeState().multiPolys,e=this.afterState().multiPolys;switch(ct.type){case"union":var r=0===t.length,n=0===e.length;this._isInResult=r!==n;break;case"intersection":var i,o;t.length<e.length?(i=t.length,o=e.length):(i=e.length,o=t.length),this._isInResult=o===ct.numMultiPolys&&i<o;break;case"xor":var s=Math.abs(t.length-e.length);this._isInResult=s%2==1;break;case"difference":var a=function(t){return 1===t.length&&t[0].isSubject};this._isInResult=a(t)!==a(e);break;default:throw new Error("Unrecognized operation type found ".concat(ct.type))}return this._isInResult}}],[{key:"fromRing",value:function(e,r,n){var i,o,s,a=K.comparePoints(e,r);if(a<0)i=e,o=r,s=1;else{if(!(a>0))throw new Error("Tried to create degenerate segment at [".concat(e.x,", ").concat(e.y,"]"));i=r,o=e,s=-1}return new t(new K(i,!0),new K(o,!1),[n],[s])}}]),t}(),rt=function(){function t(e,r,n){if(j(this,t),!Array.isArray(e)||0===e.length)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=r,this.isExterior=n,this.segments=[],"number"!=typeof e[0][0]||"number"!=typeof e[0][1])throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=J.round(e[0][0],e[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,s=1,a=e.length;s<a;s++){if("number"!=typeof e[s][0]||"number"!=typeof e[s][1])throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=J.round(e[s][0],e[s][1]);l.x===o.x&&l.y===o.y||(this.segments.push(et.fromRing(o,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),o=l)}i.x===o.x&&i.y===o.y||this.segments.push(et.fromRing(o,i,this))}return M(t,[{key:"getSweepEvents",value:function(){for(var t=[],e=0,r=this.segments.length;e<r;e++){var n=this.segments[e];t.push(n.leftSE),t.push(n.rightSE)}return t}}]),t}(),nt=function(){function t(e,r){if(j(this,t),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new rt(e[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var n=1,i=e.length;n<i;n++){var o=new rt(e[n],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=r}return M(t,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),e=0,r=this.interiorRings.length;e<r;e++)for(var n=this.interiorRings[e].getSweepEvents(),i=0,o=n.length;i<o;i++)t.push(n[i]);return t}}]),t}(),it=function(){function t(e,r){if(j(this,t),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{"number"==typeof e[0][0][0]&&(e=[e])}catch(t){}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var n=0,i=e.length;n<i;n++){var o=new nt(e[n],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=r}return M(t,[{key:"getSweepEvents",value:function(){for(var t=[],e=0,r=this.polys.length;e<r;e++)for(var n=this.polys[e].getSweepEvents(),i=0,o=n.length;i<o;i++)t.push(n[i]);return t}}]),t}(),ot=function(){function t(e){j(this,t),this.events=e;for(var r=0,n=e.length;r<n;r++)e[r].segment.ringOut=this;this.poly=null}return M(t,null,[{key:"factory",value:function(e){for(var r=[],n=0,i=e.length;n<i;n++){var o=e[n];if(o.isInResult()&&!o.ringOut){for(var s=null,a=o.leftSE,l=o.rightSE,u=[a],h=a.point,c=[];s=a,a=l,u.push(a),a.point!==h;)for(;;){var f=a.getAvailableLinkedEvents();if(0===f.length){var p=u[0].point,y=u[u.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(p.x,",")+" ".concat(p.y,"]. Last matching segment found ends at")+" [".concat(y.x,", ").concat(y.y,"]."))}if(1===f.length){l=f[0].otherSE;break}for(var g=null,d=0,v=c.length;d<v;d++)if(c[d].point===a.point){g=d;break}if(null===g){c.push({index:u.length,point:a.point});var m=a.getLeftmostComparator(s);l=f.sort(m)[0].otherSE;break}var b=c.splice(g)[0],x=u.splice(b.index);x.unshift(x[0].otherSE),r.push(new t(x.reverse()))}r.push(new t(u))}}return r}}]),M(t,[{key:"getGeom",value:function(){for(var t=this.events[0].point,e=[t],r=1,n=this.events.length-1;r<n;r++){var i=this.events[r].point,o=this.events[r+1].point;0!==Y(i,t,o)&&(e.push(i),t=i)}if(1===e.length)return null;var s=e[0],a=e[1];0===Y(s,t,a)&&e.shift(),e.push(e[0]);for(var l=this.isExteriorRing()?1:-1,u=this.isExteriorRing()?0:e.length-1,h=this.isExteriorRing()?e.length:-1,c=[],f=u;f!=h;f+=l)c.push([e[f].x,e[f].y]);return c}},{key:"isExteriorRing",value:function(){if(void 0===this._isExteriorRing){var t=this.enclosingRing();this._isExteriorRing=!t||!t.isExteriorRing()}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return void 0===this._enclosingRing&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],e=1,r=this.events.length;e<r;e++){var n=this.events[e];K.compare(t,n)>0&&(t=n)}for(var i=t.segment.prevInResult(),o=i?i.prevInResult():null;;){if(!i)return null;if(!o)return i.ringOut;if(o.ringOut!==i.ringOut)return o.ringOut.enclosingRing()!==i.ringOut?i.ringOut:i.ringOut.enclosingRing();i=o.prevInResult(),o=i?i.prevInResult():null}}}]),t}(),st=function(){function t(e){j(this,t),this.exteriorRing=e,e.poly=this,this.interiorRings=[]}return M(t,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(null===t[0])return null;for(var e=0,r=this.interiorRings.length;e<r;e++){var n=this.interiorRings[e].getGeom();null!==n&&t.push(n)}return t}}]),t}(),at=function(){function t(e){j(this,t),this.rings=e,this.polys=this._composePolys(e)}return M(t,[{key:"getGeom",value:function(){for(var t=[],e=0,r=this.polys.length;e<r;e++){var n=this.polys[e].getGeom();null!==n&&t.push(n)}return t}},{key:"_composePolys",value:function(t){for(var e=[],r=0,n=t.length;r<n;r++){var i=t[r];if(!i.poly)if(i.isExteriorRing())e.push(new st(i));else{var o=i.enclosingRing();o.poly||e.push(new st(o)),o.poly.addInterior(i)}}return e}}]),t}(),lt=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:et.compare;j(this,t),this.queue=e,this.tree=new U(r),this.segments=[]}return M(t,[{key:"process",value:function(t){var e=t.segment,r=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(e),r;var n=t.isLeft?this.tree.insert(e):this.tree.find(e);if(!n)throw new Error("Unable to find segment #".concat(e.id," ")+"[".concat(e.leftSE.point.x,", ").concat(e.leftSE.point.y,"] -> ")+"[".concat(e.rightSE.point.x,", ").concat(e.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var i=n,o=n,s=void 0,a=void 0;void 0===s;)null===(i=this.tree.prev(i))?s=null:void 0===i.key.consumedBy&&(s=i.key);for(;void 0===a;)null===(o=this.tree.next(o))?a=null:void 0===o.key.consumedBy&&(a=o.key);if(t.isLeft){var l=null;if(s){var u=s.getIntersection(e);if(null!==u&&(e.isAnEndpoint(u)||(l=u),!s.isAnEndpoint(u)))for(var h=this._splitSafely(s,u),c=0,f=h.length;c<f;c++)r.push(h[c])}var p=null;if(a){var y=a.getIntersection(e);if(null!==y&&(e.isAnEndpoint(y)||(p=y),!a.isAnEndpoint(y)))for(var g=this._splitSafely(a,y),d=0,v=g.length;d<v;d++)r.push(g[d])}if(null!==l||null!==p){var m=null;if(null===l)m=p;else if(null===p)m=l;else{m=K.comparePoints(l,p)<=0?l:p}this.queue.remove(e.rightSE),r.push(e.rightSE);for(var b=e.split(m),x=0,w=b.length;x<w;x++)r.push(b[x])}r.length>0?(this.tree.remove(e),r.push(t)):(this.segments.push(e),e.prev=s)}else{if(s&&a){var E=s.getIntersection(a);if(null!==E){if(!s.isAnEndpoint(E))for(var S=this._splitSafely(s,E),_=0,k=S.length;_<k;_++)r.push(S[_]);if(!a.isAnEndpoint(E))for(var I=this._splitSafely(a,E),P=0,T=I.length;P<T;P++)r.push(I[P])}}this.tree.remove(e)}return r}},{key:"_splitSafely",value:function(t,e){this.tree.remove(t);var r=t.rightSE;this.queue.remove(r);var n=t.split(e);return n.push(r),void 0===t.consumedBy&&this.tree.insert(t),n}}]),t}(),ut="undefined"!=typeof process&&process.env.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,ht="undefined"!=typeof process&&process.env.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,ct=new(function(){function t(){j(this,t)}return M(t,[{key:"run",value:function(t,e,r){ct.type=t,J.reset();for(var n=[new it(e,!0)],i=0,o=r.length;i<o;i++)n.push(new it(r[i],!1));if(ct.numMultiPolys=n.length,"difference"===ct.type)for(var s=n[0],a=1;a<n.length;)null!==G(n[a].bbox,s.bbox)?a++:n.splice(a,1);if("intersection"===ct.type)for(var l=0,u=n.length;l<u;l++)for(var h=n[l],c=l+1,f=n.length;c<f;c++)if(null===G(h.bbox,n[c].bbox))return[];for(var p=new U(K.compare),y=0,g=n.length;y<g;y++)for(var d=n[y].getSweepEvents(),v=0,m=d.length;v<m;v++)if(p.insert(d[v]),p.size>ut)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var b=new lt(p),x=p.size,w=p.pop();w;){var E=w.key;if(p.size===x){var S=E.segment;throw new Error("Unable to pop() ".concat(E.isLeft?"left":"right"," SweepEvent ")+"[".concat(E.point.x,", ").concat(E.point.y,"] from segment #").concat(S.id," ")+"[".concat(S.leftSE.point.x,", ").concat(S.leftSE.point.y,"] -> ")+"[".concat(S.rightSE.point.x,", ").concat(S.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(p.size>ut)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(b.segments.length>ht)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var _=b.process(E),k=0,I=_.length;k<I;k++){var P=_[k];void 0===P.consumedBy&&p.insert(P)}x=p.size,w=p.pop()}J.reset();var T=ot.factory(b.segments);return new at(T).getGeom()}}]),t}()),ft={union:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return ct.run("union",t,r)},intersection:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return ct.run("intersection",t,r)},xor:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return ct.run("xor",t,r)},difference:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return ct.run("difference",t,r)}},pt=function(){function r(t){this.cache={},this.config=t,this.api=new P(t.baseUrl)}return r.prototype.long2tile=function(t,e){return Math.floor((t+180)/360*Math.pow(2,e))},r.prototype.lat2tile=function(t,e){return Math.floor((1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e))},r.prototype.tile2long=function(t,e){return t/Math.pow(2,e)*360-180},r.prototype.tile2lat=function(t,e){var r=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))},r.prototype.coordinatesToOsm=function(t,e){return{lat:this.tile2long(this.long2tile(t.lat,e),e),lng:this.tile2lat(this.lat2tile(t.lng,e),e)}},r.prototype.coordinatesToOsmBottom=function(t,e){return{lat:this.tile2long(this.long2tile(t.lat,e)+1,e),lng:this.tile2lat(this.lat2tile(t.lng,e)+1,e)}},r.prototype.getOSMBoundingBox=function(t,e){var r={lat:0,lng:0},n={lat:0,lng:0},i=this.long2tile(e[0],t),o=this.lat2tile(e[1],t);r.lat=this.tile2long(i+1,t),r.lng=this.tile2lat(o,t);var s=this.long2tile(e[2],t),a=this.lat2tile(e[3],t);return n.lat=this.tile2long(s,t),n.lng=this.tile2lat(a+1,t),[r.lat,r.lng,n.lat,n.lng]},r.prototype.getLayerData=function(r,n){return t(this,void 0,void 0,(function(){var t,i,o,s,a,l,u,h,c,f,p,y,g;return e(this,(function(e){switch(e.label){case 0:if("Things"==(t=JSON.parse(JSON.stringify(this.config.queryObject))).entityType)t.select=["id"],t.expand=[{entityType:"Locations"}];else{if("FeaturesOfInterest"!=t.entityType)throw new Error("Only Things and FeaturesOfInterest are supported");t.select=["feature"]}if(i=this.getOSMBoundingBox(r,n),o=i[0],s=i[1],a=i[2],l=i[3],this.cache[r]){if(h=[[[o,s],[o,l],[a,l],[a,s],[o,s]]],c=(c=this.cache[r].features.filter((function(t){return t.properties.count}))).map((function(t){return t.geometry.coordinates})),!(f=ft.difference.apply(ft,function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),i=0;for(e=0;e<r;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)n[i]=o[s];return n}([h],c)))[0])return[2,this.cache[r]];u=dt(f,t.entityType)}else u="geo.intersects("+("Things"==t.entityType?"Locations/location":"feature")+",geography'POLYGON (("+o+" "+s+", "+o+" "+l+", "+a+" "+l+", "+a+" "+s+" ,"+o+" "+s+"))')";return t.filter?t.filter="("+t.filter+") and "+u:t.filter=u,t.top||(t.top=1e3),[4,this.api.getGeoJson(t)];case 1:return p=e.sent(),this.cache[r]||(this.cache[r]={type:"FeatureCollection",features:[]}),p?(y="Things"==t.entityType?p.value.map((function(t){return t.Locations[0].location})):p.value.map((function(t){return t.feature})))[0]&&"Point"==y[0].type?[4,this.cluster(y,r)]:[3,3]:[3,4];case 2:return e.sent(),[3,4];case 3:(g=this.cache[r].features).push.apply(g,y),e.label=4;case 4:return[2,this.cache[r]]}}))}))},r.prototype.cluster=function(r,n){return t(this,void 0,void 0,(function(){var t,i,o,s,a,l,u=this;return e(this,(function(e){switch(e.label){case 0:return r=r.map((function(t){var e=u.coordinatesToOsm({lat:t.coordinates[0],lng:t.coordinates[1]},n),r=u.coordinatesToOsmBottom({lat:t.coordinates[0],lng:t.coordinates[1]},n);return{type:"Feature",geometry:{type:"Polygon",coordinates:[[[e.lat,e.lng],[e.lat,r.lng],[r.lat,r.lng],[r.lat,e.lng],[e.lat,e.lng]]]},properties:{count:1}}})),t=[],r.forEach((function(e){var r=t.find((function(t){return yt(e,t)}));r?r.properties.count=r.properties.count+1:t.push(e)})),t=t.filter((function(t){return!u.cache[n].features.some((function(e){return yt(t,e)}))})),i=[],t=t.filter((function(t){return!(t.properties.count<u.config.clusterMin)||(i.push([t.geometry.coordinates]),!1)})),(l=this.cache[n].features).push.apply(l,t),0==i.length?[3,2]:(o=ft.union.apply(ft,i))?("Things"==(s=JSON.parse(JSON.stringify(this.config.queryObject))).entityType?(s.expand||(s.expand=[]),(a=s.expand.find((function(t){return"Datastreams"==t.entityType})))?(a.select&&!a.select.includes("id")&&a.select.push("id"),a.select&&!a.select.includes("name")&&a.select.push("name")):s.expand.push({entityType:"Datastreams",select:["id","name"],expand:[{entityType:"observedProperty"}]}),s.expand.some((function(t){return"Locations"==t.entityType}))||s.expand.push({entityType:"Locations"})):s.select&&!s.select.includes("feature")&&s.select.push("feature"),s.filter&&(s.filter="("+s.filter+") and "),s.filter=s.filter?s.filter:""+dt(o,s.entityType),[4,this.api.getGeoJson(s)]):[3,2];case 1:e.sent().value.forEach((function(t){var e;if(e="Things"==s.entityType?t.Locations[0].location:t.feature,delete t.Locations,e.properties=t,t.getData||(t.getData={}),"Things"==s.entityType)for(var r=0,i=t.Datastreams;r<i.length;r++){var o=i[r];t.getData[o.ObservedProperty.name]=function(t){var e={entityType:"Datastreams",id:o["@iot.id"],expand:[{entityType:"Observations",filter:t}]};return this.api.getGeoJson(e)}.bind(u)}console.log(t),u.cache[n].features.some((function(t){return yt(e,t)}))||u.cache[n].features.push(e)})),e.label=2;case 2:return[2]}}))}))},r}();function yt(t,e){return t.type==e.type&&("Point"==t.type?gt(t.coordinates,e.coordinates):gt(t.geometry.coordinates,e.geometry.coordinates))}function gt(t,e){return JSON.stringify(t)===JSON.stringify(e)}function dt(t,e){return t.map((function(t){return null!=t[0][0][0]&&(t=t[0]),"geo.intersects("+("Things"==e?"Locations/location":"feature")+",geography'POLYGON (("+t.map((function(t){return t.join(" ")})).join(",")+"))')"})).join(" or ")}var vt,mt,bt={blueIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),goldIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),redIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),greenIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),orangeIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),yellowIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),violetIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),greyIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),blackIcon:new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png",shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})};function xt(t){switch(t){case"green":return bt.greenIcon;case"black":return bt.blackIcon;case"blue":return bt.blueIcon;case"grey":return bt.greyIcon;case"violet":return bt.violetIcon;case"yellow":return bt.yellowIcon;case"red":return bt.redIcon;case"orange":return bt.orangeIcon;case"gold":return bt.goldIcon;default:return new L.Icon.Default}}if("undefined"!=typeof L){var wt,Et=[];L.Stam=L.LayerGroup.extend({initialize:function(t){var e,r=new pt(t),n=function(t){t.setStyle(i.default),e=null},i={default:{opacity:0,fillOpacity:0},highlight:{color:"red",opacity:1}};this.on("add",(function(){if(null!=this._map){var o,s=this._map,a=s.getZoom(),l=function(r,l){var u;if(o&&(wt.clearLayers(),o=!1),"Polygon"==(null===(u=r.geometry)||void 0===u?void 0:u.type)&&r.properties.count){l.on("mouseover",(function(){t.clusterMouseOver&&t.clusterMouseOver(r),function(t){e&&n(e),t.setStyle(i.highlight),e=t}(l)})),l.on("mouseout",(function(){n(l)})),l.on("click",(function(){if(t.clusterClick){var e=t.clusterClick(r);if(e)return l.bindPopup(e)}s.fitBounds(l.getBounds())})),l.setStyle(i.default);var h=l.getBounds(),c=(h._northEast.lat+h._southWest.lat)/2,f=(h._northEast.lng+h._southWest.lng)/2,p=L.circleMarker(L.latLng(c,f),{radius:3*a});p.bindTooltip("<span>"+r.properties.count+"</span>",{permanent:!0,direction:"center",className:"count"}),wt.addLayer(p)}else l.on("click",(function(){if(t.markerClick){var e=t.markerClick(r);if(e)return l.bindPopup(e)}l.bindPopup("<span>"+JSON.stringify(r.properties)+"</span>")})),l.on("mouseover",(function(){if(t.markerMouseOver)return t.markerMouseOver(r)}))},u=function(e,r){return L.marker(r,{icon:"function"==typeof t.markerStyle?xt(t.markerStyle(e)):"string"==typeof t.markerStyle?xt(t.markerStyle):new L.Icon.Default})};s.on("layeradd",(function(){var e=this;s.off("layeradd"),wt=L.layerGroup(),this.addLayer(wt);var n=s.getBounds();r.getLayerData(s.getZoom(),[n._northEast.lng,n._northEast.lat,n._southWest.lng,n._southWest.lat]).then((function(r){var n=L.geoJSON(r,{onEachFeature:l,pointToLayer:u,style:t.clusterStyle});Et.push(n),e.addLayer(n)}))})),s.on("moveend",(function(){var e=this;a!=s.getZoom()&&(a=s.getZoom()),o=!0;var n=s.getBounds();r.getLayerData(s.getZoom(),[n._northEast.lng,n._northEast.lat,n._southWest.lng,n._southWest.lat]).then((function(r){var n=L.geoJSON(r,{onEachFeature:l,pointToLayer:u,style:t.clusterStyle});Et.forEach((function(t){t.remove()})),Et.push(n),e.addLayer(n)}))}))}}))}}),L.stam=function(t){return new L.Stam(t)};var St=".leaflet-tooltip.count {background-color: transparent;border: transparent;  box-shadow: none;  font-weight: bold;font-size: 20px;}",_t=document.head||document.getElementsByTagName("head")[0],kt=document.createElement("style");_t.appendChild(kt),kt.type="text/css",kt.styleSheet?kt.styleSheet.cssText=St:kt.appendChild(document.createTextNode(St))}if("undefined"!=typeof ol){var It,Pt,Tt=[],Ot=function(t){Pt=t.map,ol.layer.Group.call(this,t),It=Pt.getView().getZoom().toFixed(0);var e=new pt(t);Pt.on("moveend",(function(){It!=Pt.getView().getZoom()&&(It=Pt.getView().getZoom().toFixed(0)),function(t,e){return new Promise((function(r,n){var i;if("EPSG:4326"==Pt.getView().getProjection().code_)i=Pt.getView().calculateExtent();else{var o=Pt.getView().calculateExtent(),s=Pt.getView().getProjection().getCode();(i=[]).push.apply(i,new ol.geom.Point([o[2],o[3]]).transform(s,"EPSG:4326").getCoordinates()),i.push.apply(i,new ol.geom.Point([o[0],o[1]]).transform(s,"EPSG:4326").getCoordinates())}t.getLayerData(e,i).then((function(t){var e=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(t,{featureProjection:Pt.getView().getProjection().getCode()})}),n=new ol.layer.Vector({source:e});r(n)}))}))}(e,It).then(function(t){this.getLayers().array_.push(t),this.changed(),this.getLayers().array_=this.getLayers().array_.filter(function(t){return-1==Tt.indexOf(t)}.bind(this)),Pt.render(),(Tt=[]).push(t)}.bind(this))}))};vt=Ot,mt=ol.layer.Group,vt.prototype=Object.create(mt.prototype),vt.prototype.constructor=vt,ol.layer.STAM=Ot}}();
